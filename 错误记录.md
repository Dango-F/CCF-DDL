# uni-app 项目错误记录

## 错误 1：端口权限被拒绝

### 错误信息

```
error when starting dev server:
Error: listen EACCES: permission denied ::1:5173
```

### 原因

端口 5173 被占用或没有权限访问。

### 解决方案

**方法 1：换一个端口**

在 `vite.config.ts` 中添加配置：

```ts
export default defineConfig({
  server: {
    port: 3000, // 换一个端口
    host: "0.0.0.0",
  },
});
```

**方法 2：以管理员身份运行终端**

右键 VS Code 或终端，选择"以管理员身份运行"。

```powershell
# 查看占用 5173 端口的进程
netstat -ano | findstr :5173

# 结束进程（替换 PID 为实际进程 ID）
taskkill /PID <PID> /F
```

---

## 错误 2：TypeScript 配置已弃用选项

### 错误信息

选项"importsNotUsedAsValues"已删除。请从配置中删除它。

```

### 原因


### 解决方案
在 `tsconfig.json` 中添加：

{
  "compilerOptions": {
    "verbatimModuleSyntax": false
  }
```

## 错误 3：找不到类型定义文件

### 错误信息

```
找不到"types/wechat-miniprogram"的类型定义文件。

### 原因

类型包名称或路径不正确。

### 解决方案

1. 安装正确的包：

```

2. 在 `tsconfig.json` 中修正类型引用：

```json
{
  "compilerOptions": {
    "types": [
      "@dcloudio/types",
      "miniprogram-api-typings",
      "@uni-helper/uni-app-types"
    ]
  }
}
```

---

## 错误 4：Node.js 版本过低

### 错误信息

```
npm WARN EBADENGINE Unsupported engine {
  package: 'vite@5.2.8',
  required: { node: '^18.0.0 || >=20.0.0' },
  current: { node: 'v16.20.2', npm: '8.19.4' }
}
```

### 原因

当前 Node.js 版本 (v16) 不满足依赖包要求 (v18+)。

### 解决方案

升级 Node.js 到 18 或更高版本：

```bash
# 使用 nvm 切换版本
nvm install 22
nvm use 22
```

---

## 错误 5：依赖版本冲突

### 错误信息

```
npm error ERESOLVE could not resolve
peer vite@"5.2.8" from @dcloudio/vite-plugin-uni@3.0.0-4080420251103001
```

### 原因

`@dcloudio/vite-plugin-uni` 要求特定版本的 vite (5.2.8)，但安装了不兼容的版本。

### 解决方案

保持 vite 版本与 uni-app 兼容：

```bash
npm install -D vite@5.2.8
```

---

## 提示信息

### uni-app 版本更新提示

```
uni-app 有新版本发布，请执行 `npx @dcloudio/uvm@latest` 更新
```

如需更新 uni-app，运行：

```bash
npx @dcloudio/uvm@latest
```

---

## 最终配置参考

### tsconfig.json

```json
{
  "extends": "@vue/tsconfig/tsconfig.json",
  "compilerOptions": {
    "ignoreDeprecations": "5.0",
    "verbatimModuleSyntax": false,
    "sourceMap": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "lib": ["esnext", "dom"],
    "types": [
      "@dcloudio/types",
      "miniprogram-api-typings",
      "@uni-helper/uni-app-types"
    ]
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts", "src/**/*.tsx", "src/**/*.vue"]
}
```

### 推荐的 Node.js 版本

- Node.js 18.x 或 20.x 或 22.x

---

## 错误 6：调用不存在的 Store 方法

### 错误信息

```
属性"loadConferences"在类型"Store<...>"上不存在。你是否指的是"conferences"?
```

### 原因

在 `detail.vue` 中调用了 `store.loadConferences()`，但 store 中没有定义这个方法。

### 解决方案

使用正确的方法名：

```typescript
// 错误
store.loadConferences();

// 正确 - 从缓存加载
store.loadFromCache();

// 正确 - 从远程获取
await store.fetchRemoteConferences();
```

---

## 错误 7：数组索引可能返回 undefined

### 错误信息

```
类型"string | undefined"的参数不能赋给类型"string"的参数。
不能将类型"undefined"分配给类型"string"。
```

### 原因

TypeScript 严格模式下，`array[index]` 可能返回 `undefined`（数组越界时）。

### 解决方案

添加默认值保护：

```typescript
// 错误
const level = levels[index] === "全部" ? "" : levels[index];

// 正确
const level = levels[index] === "全部" ? "" : levels[index] || "";
```

---

## 错误 8：H5 端网络检测不准确

### 问题描述

使用 `#ifdef H5` 条件编译配合 `fetch` 检测网络状态，但在 H5 端总是显示"已使用 HTTP 缓存数据"。

### 原因

1. uni-app 的条件编译 `#ifdef H5` 在 Vite 开发模式下可能不生效
2. `fetch` 使用 `mode: 'no-cors'` 返回 opaque response，无法可靠判断网络状态
3. CORS 策略导致跨域请求可能失败

### 解决方案

**方案 1：简化逻辑**（推荐）

既然数据请求成功就说明网络正常，不需要额外检测：

```typescript
// 请求成功直接显示更新成功
uni.showToast({ title: "数据已更新", icon: "success" });
```

**方案 2：App 端使用原生 API**

```typescript
// #ifdef APP-PLUS
uni.getNetworkType({
  success: (res) => {
    const isOnline = res.networkType !== "none";
  },
});
// #endif
```

---

## 错误 9：iPhone 底部安全区域适配

### 问题描述

在 iPhone X 及以上机型，固定在底部的按钮可能被 Home Indicator（底部横条）遮挡。

### 解决方案

使用 CSS 环境变量适配安全区域：

```scss
.add-calendar-btn {
  position: fixed;
  bottom: 20px; /* 默认值，兼容旧浏览器 */
  bottom: calc(20px + constant(safe-area-inset-bottom)); /* iOS 11.0-11.2 */
  bottom: calc(20px + env(safe-area-inset-bottom)); /* iOS 11.2+ */
}
```

---

## 错误 10：日历 API 调用失败（跨端兼容）

### 问题描述

在 App（APP-PLUS）端尝试使用 `plus.calendar` 或跨平台统一 API 添加日程时，出现 `TypeError` 或不一致行为：某些 Android 设备或 iOS 运行环境无法访问 `plus.calendar`，导致无法自动加入日历，抛出异常或无响应。

### 错误信息（示例）

```
TypeError: plus.calendar is undefined
```

### 原因

- `plus.calendar` 在部分平台或运行时并不稳定或不可用。
- 直接调用原生类/API（例如 Android 的 CalendarContract 或 iOS 的 EventKit）会在主线程做大量初始化（导入类、加载常驻资源）导致 UI 卡顿或抛异常。
- 在 iOS 上，受沙箱限制或 EventKit 针对权限的行为差异，额外使用原生方法比生成 .ics 文件更复杂。

### 解决方案

1. 针对 Android：放弃 `plus.calendar`，使用 `plus.android.importClass` 调用 `android.content.Intent` + `android.provider.CalendarContract`，通过 Intent 发起添加事件。为避免首次加载 native 类卡顿，使用 `uni.showLoading` 显示加载遮罩，并用 `setTimeout` 将 native 调用推迟（现已从 10ms 修改为 50ms），确保 Loading 能够先渲染出来再执行占用较高的原生初始化。

2. 针对 iOS：生成标准 `.ics` 日历文件（在 `_doc/` 目录下写文件），然后使用 `plus.runtime.openFile` 触发系统分享/导入界面，让系统帮忙打开处理，避免直接调用 EventKit 相关的原生代码以减少权限/兼容性问题。

3. 异常处理与用户提示：对原生调用添加 try/catch，失败时 `console.error` 并 `uni.showToast({ title: '调起日历失败', icon: 'none', duration: 1000 })`，并隐藏 Loading（`uni.hideLoading()`）。

4. TypeScript 兼容性：在 iOS 的文件系统代码中，`fs.root` 可能为 `undefined`，为此增加了类型保护（null/undefined 检查）并在代码中增加注释说明以避免静态检查报错。

### 已知变更记录

- Android：添加了 `uni.showLoading({ title: '正在启动日历...', mask: true })`，并用 `setTimeout(..., 50)` 包裹对 `plus.android.importClass` 和 `startActivity` 的调用。
- iOS：使用 `plus.io.requestFileSystem` 写入 `.ics` 并用 `plus.runtime.openFile` 调用系统处理；增加 `fs.root` 为空判断。

---

## 修复 11：首次使用加入日程卡顿（优化）

### 问题描述

在部分 Android 设备上，首次点击“加入日程”会出现短暂卡顿（主线程阻塞），用户看到 Loading 遮罩但页面响应不流畅。

### 根因

导入原生类（如通过 `plus.android.importClass` 加载 Intent/CalendarContract）在某些设备会进行较多初始化，占用 UI 线程，造成卡顿。

### 解决方案

在弹出 Loading 后将繁重的原生初始化工作放到下一个事件循环中执行（使用 `setTimeout`），这样可以让 Loading 先绘制完成再执行耗时操作。把延时从 10ms 调整为 50ms，以确保在更慢设备上也能顺滑渲染。

---

## 修复 12：优化提示持续时间（全局统一）

### 问题描述

项目中不同文件里 `uni.showToast` 的 `duration` 值不一致（部分 1500ms，部分无设置，导致体验差异）。

### 变更说明

将全项目中常见提示的持续时间统一设为 1000ms（1 秒），主要影响文件：

- `src/pages/detail/detail.vue`：已为 `duration: 1000`。
- `src/pages/favorites/favorites.vue`：将 `已清空` 持续时间从 1500ms 修改为 1000ms。
- `src/stores/conference.ts`：将多处 `duration: 1500` 修改为 `duration: 1000`，并为部分没有 `duration` 的统一加上 `duration: 1000`。

### 目的

一致的 Toast 持续时间提升用户体验并减少提示冗长导致的界面节奏问题。

---

## 跨端兼容最佳实践

### 1. 样式隔离

所有组件使用 `scoped` 样式：

---

## 修复 13：避免把空数组覆盖主缓存（saveToCache 加固）

### 问题描述

在部分情况下，写缓存逻辑会把主缓存覆盖为一个空数组（例如临时写入失败或传入空数据时），导致页面显示空列表。

### 变更

- `src/stores/conference.ts` 中 `saveToCache` 增强：

  - 增加了对 `data` 的校验，拒绝写入空数组或非数组。
  - 在提升临时缓存时，改为只有当 `tmp` 为非空数组（`Array.isArray(tmp) && tmp.length > 0`）才 promote 到主缓存，避免把主缓存替换为空数组。

  ***

  ## 错误 14（Lint/TS 报错升级） & 修复记录 2025-12-08

  ### 简述

  最近在运行 `npm run lint` 和 `npx tsc --noEmit` 时，出现了较多 ESLint 与 TypeScript 报错，涉及 `any` 类型、未使用变量、空对象类型、以及 `@typescript-eslint` 插件/版本差异。下面记录发现、修复与待决事项。

  ### 错误/警告

  - TypeScript 版本与 `@typescript-eslint` 解析器版本不在兼容范围（警告: TypeScript 5.9.3, parser 支持到 < 5.4.0）。
  - ESLint: `@typescript-eslint/no-explicit-any` 在 `src` 中报错较多。
  - ESLint: `@typescript-eslint/no-empty-object-type` 在 `.d.ts`（`env.d.ts`, `shime-uni.d.ts`）中触发。
  - ESLint: `@typescript-eslint/ban-types` 定义缺失（`Definition for rule '@typescript-eslint/ban-types' was not found`），这表明插件可能未安装或版本不匹配。
  - ESLint: `@typescript-eslint/no-unused-vars` 对 `catch (e)` 的 `e` 与某些局部变量（例: `rateStr`）报未使用警告。

  ### 已采取修复（已提交）

  1. 将 `node_modules/` 添加到 `.gitignore`（仓库已包含）；避免把 node_modules 提交进仓库。
  2. 在 `src/utils/logger.ts` 中，不再使用 `any[]`，采用 `Parameters<typeof console.log>` 等类型签名替代 `any`。
  3. 在 `src/stores/conference.ts` 中引入并使用以下类型：

  - `AcceptRateEntry` 与 `AcceptRateIndex`，为接受率 JSON 提供明确类型。
  - `RawParsedItem`, `RawConf`, `RawTimelineItem` 用于 `yaml` 解析结构。

  4. 将多个 `any` 替换为更精确类型（`Conference`, `AcceptRateEntry[]`, `Unknown` 等），并对 `parseNumber` 参数使用 `unknown`，对返回类型声明 `number`。
  5. 规范化对 `resp.data` 的处理：检测并将 `rawData` 归一到 `AcceptRateEntry` / `AcceptRateEntry[] / string`，避免类型访问错误。
  6. 修复 `catch (e)` → `catch {}` 的未使用变量警告；在需要记录错误时仍保留 `catch (e)` 并把 `e` 传给 `logger.warn`/`error`。
  7. 在 `env.d.ts` 与 `shime-uni.d.ts` 中修改类型声明以避开 `no-empty-object-type` 报错：使用 `Record<string, unknown>`，或加上 `eslint-disable` 注释说明用途。
  8. 在多个 Reduce 与数组操作中引入具体的泛型参数（例如 `arr.reduce((acc: AcceptRateEntry | null, cur: AcceptRateEntry) => { ... })`），避免 `any` 的使用。
  9. 处理 `bestDeadline.deadline` 的潜在 undefined，使用 `??` 回退（`deadlineStr = bestDeadline.deadline ?? deadlineStr`）。
  10. 添加 `.gitignore`（包含 `node_modules/`, `dist/`, `*.log`, `.env` 等），避免提交大体积或敏感文件。

  ### 运行验证

  - `npx tsc --noEmit`：通过（所有 TS 报错已清除）
  - `npm run lint`：通过（ESLint 不再报错）

  ### 待决项 / 建议

  1. TypeScript 版本：当前 TS 版本（5.9.3）不在 `@typescript-eslint` 支持范围，建议：

  - 把 `@typescript-eslint/parser` 和 `@typescript-eslint/eslint-plugin` 更新到支持 5.9.x 的版本；或
  - 把本项目 TypeScript 降级到 5.3.x（短期可行）以匹配解析器支持范围。

  2. 团队风格选择：是否把 `@typescript-eslint/no-explicit-any` 限制改为 `warn`，并在修复关键路径时逐步替换 `any`。
  3. CI 校验：建议在 CI 中加入 `npx tsc --noEmit` 和 `npm run lint` 步骤，确保新提交不会破坏类型/规则。
  4. 上线包安全：目前 `vite` 配置已在生产构建时移除 console/sourcemap，建议在 CI 中再加一层静态检测（例如 `scripts/check-no-console.js`）以避免意外输出。

  ***

  （记录由自动化改造：替换 `any`、增加类型声明、移除未使用变量并修正 catch 语法；如需回滚部分规则请说明）

  - `saveToCache` 现在返回 `boolean` 表示写入是否成功，调用方可根据返回值决定是否提示或重试。

### 影响

- 防止空数组覆盖旧缓存，提升离线/网络失败情况下的稳定性。
- 在 `fetchRemoteConferences` 中对 `saveToCache` 的返回值做了检查并在失败时记录警告日志：`未写入本地缓存：数据为空或写入失败，保留旧缓存`。

---

## 修复 14：详情页在离线时不再发起重复刷新（减少重复提示）

### 问题描述

在无网状态下，进入会议详情页会触发额外的 `fetchRemoteConferences()` 调用，导致出现重复的“使用缓存”提示（Toast）并产生无效的网络尝试。

### 变更

- `src/pages/detail/detail.vue` 中 `onLoad` 的逻辑调整：
  - 先从 store 中查找会议；若未找到则 `loadFromCache()` 再次尝试；只有在未找到且 `store.isNetworkError` 为 false（即网络看起来在线）时才调用 `fetchRemoteConferences()`。
  - 若会议已存在于 store，则仅在 `!store.lastUpdated && !store.isNetworkError` 的情况下才尝试 fetch。

### 影响

- 离线时点击详情页将保持当前缓存显示，不会触发额外网络请求或重复的缓存提示，提升用户体验。

---

## 修复 15：详情页样式调整（标题与链接顶端对齐；改善换行）

### 问题描述

手机端显示时，`会议全称` 或 `官网链接` 的右侧值在多行时与左侧标签未顶端对齐，且某些短文本被 `word-break: break-all` 异常拆分，造成视觉错位。

### 变更

- 在 `src/pages/detail/detail.vue` 中：
  - 为官网链接行添加 `link-row` 类：`<view class="row link-row" ...>`。
  - 将 `.row.title-row` 与 `.row.link-row` 的对齐改为 `align-items: flex-start`，并把内部 `.value` 的对齐也改为顶端。
  - 把 `.value` 的换行策略从 `word-break: break-all` 改为 `word-break: normal; overflow-wrap: anywhere;`，以避免短文本被不必要地拆分。

### 影响

- 修复了手机端多行文本对齐问题, `会议全称` 与 `官网链接` 在右侧多行时与左侧标签顶部对齐, 视觉一致性更好。

---

## 备注

- 本次修改主要是为了提升离线体验和视觉一致性，改动以最小入侵为原则（不会影响已有数据模型或运行时流程）。
- 若希望进一步避免并发写入竞态，可后续在 `saveToCache` 中加入简单互斥或写队列（可另行实现）。

```vue
<style lang="scss" scoped>
/* 样式只作用于当前组件 */
</style>
```

### 2. 条件编译

针对不同平台编写特定代码：

```typescript
// #ifdef APP-PLUS
// App 端专用代码
plus.runtime.openURL(url);
// #endif

// #ifdef H5
// H5 端专用代码
window.open(url, "_blank");
// #endif
```

### 3. 使用 uni-app 基础组件

优先使用跨平台通用组件：

- `view` 代替 `div`
- `text` 代替 `span`
- `image` 代替 `img`

### 4. 安全区域适配

```scss
// 底部安全区域
padding-bottom: constant(safe-area-inset-bottom);
padding-bottom: env(safe-area-inset-bottom);

// 顶部安全区域（自定义导航栏时）
padding-top: constant(safe-area-inset-top);
padding-top: env(safe-area-inset-top);
```
